{"id":1735,"date":"2018-09-13T04:26:35","date_gmt":"2018-09-12T22:56:35","guid":{"rendered":"http:\/\/www.middlewareinventory.com\/?p=1735"},"modified":"2022-02-04T10:49:28","modified_gmt":"2022-02-04T05:19:28","slug":"ansible-ssh-key-exchange","status":"publish","type":"post","link":"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/","title":{"rendered":"Ansible SSH Key transfer from one host to another &#8211; local and remote"},"content":{"rendered":"<p>SSH Key-based authentication setup in LINUX (or) UNIX based OS is one of the major platform\u00a0services related task and most frequently executed task by Unix admins. Ansible, An IT Automation tool could automate this tedious task as well.<\/p>\n<p>SSH Key based authentication is indispensable when it comes to automation. Even some of the Ansible related tasks like SCP and RSYNC(synchronize) requires SSH Key based authentication to be enabled before running the ansible playbook.<\/p>\n<p>In this post, we are going to see<\/p>\n<p>How to enable the SSH Key-based authentication setup between multiple servers (or) hosts\u00a0using Ansible <code>ad-hoc<\/code> commands and <code>playbook<\/code><\/p>\n<p>Or How to transfer SSH Keys using ansible playbook and ad-hoc commands.<\/p>\n<h2><\/h2>\n<h2><span style=\"font-size: 18pt;\">The Objective<\/span><\/h2>\n<p>I have two Red Hat Enterprise Linux servers named <code>mwiapp01<\/code> and <code>mwiapp02<\/code> and I have to enable SSH key based (passwordless) authentication between them, in both directions.<\/p>\n<p><a href=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2019-02-01-at-12.25.15-PM.png\"><img class=\"post-img alignnone wp-image-2843 size-full\" src=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2019-02-01-at-12.25.15-PM.png\" alt=\"\" width=\"1191\" height=\"508\" srcset=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2019-02-01-at-12.25.15-PM.png 1191w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2019-02-01-at-12.25.15-PM-300x128.png 300w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2019-02-01-at-12.25.15-PM-768x328.png 768w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2019-02-01-at-12.25.15-PM-1024x437.png 1024w\" sizes=\"(max-width: 1191px) 100vw, 1191px\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<h2>Index<\/h2>\n<ol>\n<li>\u00a0The Plan ( What we are trying to achieve in this article)<\/li>\n<li>\u00a0SSH Key creation and Exchange using Ansible <strong>AD HOC<\/strong> commands<\/li>\n<li>\u00a0SSH Key Creation and Exchange using Ansible<strong> Playbook<\/strong>\n<ol style=\"list-style-type: lower-alpha;\">\n<li>\u00a0Using <strong>Shell<\/strong> Module<\/li>\n<li>\u00a0Using the <strong>authorized_key<\/strong> module<\/li>\n<\/ol>\n<\/li>\n<li>SSH Key Creation and Exchange between <strong>multiple hosts\u00a0<\/strong><\/li>\n<\/ol>\n<p>&nbsp;<\/p>\n<h2><span style=\"font-size: 18pt;\">The Plan<\/span><\/h2>\n<p>We are going to see how to achieve our objective (or) requirement using Ansible <strong>ad-hoc<\/strong> command and ansible <strong>playbook<\/strong> with and without SSH <strong>authorized_key<\/strong> module.<\/p>\n<p>Now we will see how to do this with both Ansible ad-hoc commands and playbook.<\/p>\n<p>Let us consider that I have already grouped these servers into a host group\u00a0 named &#8220;<strong>app<\/strong>&#8221; in <code>ansible_hosts<\/code> inventory file<\/p>\n<p><a href=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/TheObjective.png\"><img class=\"post-img alignnone wp-image-1756 size-full\" src=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/TheObjective.png\" alt=\" Enable SSH Key based authentication using Ansible\" width=\"741\" height=\"404\" srcset=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/TheObjective.png 741w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/TheObjective-300x164.png 300w\" sizes=\"(max-width: 741px) 100vw, 741px\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<h2><\/h2>\n<h2><span style=\"font-size: 18pt;\">Ansible AD-HOC Commands &#8211; Ansible SSH Key<\/span><\/h2>\n<p>In this method, we are going to use the Ansible ad hoc commands to perform the ssh key exchange and to copy the ssh keys between hosts. to know more about ansible ad hoc command <a href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ad-hoc-commands\/\">refer to this article<\/a><\/p>\n<p><span style=\"font-size: 14pt;\"><strong>Step 1:\u00a0<\/strong><\/span> Create SSH Private key using SSH-KEYGEN for the user <code>weblogic<\/code><\/p>\n<pre>aksarav@middlewareinventory:~$ ansible app -m shell -a \"ssh-keygen -q -b 2048 -t rsa -N '' -C 'creating SSH' -f ~\/.ssh\/id_rsa creates='~\/.ssh\/id_rsa'\" -i ansible_hosts -b &#8211; become-user=weblogic\r\n\r\nmwiapp02 | SUCCESS | rc=0 &gt;&gt;\r\nmwiapp01 | SUCCESS | rc=0 &gt;&gt;<\/pre>\n<p>&nbsp;<\/p>\n<p><strong><span style=\"font-size: 14pt;\">Step 2:<\/span>\u00a0<\/strong> Make sure the Private key file is created<\/p>\n<pre>aksarav@middlewareinventory:~$ ansible app -m shell -a \"ls -lrt\u00a0 ~\/.ssh\/id_rsa\" -i ansible_hosts -b &#8211; become-user=weblogic\r\n\r\nmwiapp02 | SUCCESS | rc=0 &gt;&gt;\r\n-rw----- &#8211; 1 weblogic weblogic 1679 Sep 10 17:25 \/home\/weblogic\/.ssh\/id_rsa\r\nmwiapp01 | SUCCESS | rc=0 &gt;&gt;\r\n-rw----- &#8211; 1 weblogic weblogic 1675 Sep 10 17:25 \/home\/weblogic\/.ssh\/id_rsa<\/pre>\n<p>&nbsp;<\/p>\n<p><span style=\"font-size: 14pt;\"><strong>Step 3:\u00a0\u00a0<\/strong><\/span>Fetch the Key\u00a0 Public Key from the servers to the ansible master<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-linenumbers=\"false\" data-enlighter-theme=\"bootstrap4\">aksarav@middlewareinventory:~$ ansible app -m fetch -a \"src='~\/.ssh\/id_rsa.pub' dest='buffer\/{{inventory_hostname}}-id_rsa.pub' flat='yes'\" -i ansible_hosts -b &#8211; become-user=weblogic\r\n\r\nmwiapp02 | SUCCESS =&gt; {\r\n\r\n    \"changed\": true,\r\n    \"checksum\": \"e128efa0cf4008d6f0a8652da44249d016a1c4fb\",\r\n    \"dest\": \"\/Users\/aksarav\/VirtualBox VMs\/vagrantVM\/buffer\/mwiapp02-id_rsa.pub\",\r\n    \"md5sum\": \"92332ffb86a310f2f7fa55e9e18e1f65\",\r\n    \"remote_checksum\": \"e128efa0cf4008d6f0a8652da44249d016a1c4fb\",\r\n    \"remote_md5sum\": null\r\n}\r\n\r\nmwiapp01 | SUCCESS =&gt; {\r\n    \"changed\": true,\r\n    \"checksum\": \"8ccbec5b91fd027e0e3ba8ca6fe2fa5e6faec0e8\",\r\n    \"dest\": \"\/Users\/aksarav\/VirtualBox VMs\/vagrantVM\/buffer\/mwiapp01-id_rsa.pub\",\r\n    \"md5sum\": \"f46044276aba3e4e6d4e918192676b76\",\r\n    \"remote_checksum\": \"8ccbec5b91fd027e0e3ba8ca6fe2fa5e6faec0e8\",\r\n    \"remote_md5sum\": null\r\n\r\n}<\/pre>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<script async src=\"https:\/\/pagead2.googlesyndication.com\/pagead\/js\/adsbygoogle.js\"><\/script>\r\n<ins class=\"adsbygoogle\"\r\n     style=\"display:block; text-align:center;\"\r\n     data-ad-layout=\"in-article\"\r\n     data-ad-format=\"fluid\"\r\n     data-ad-client=\"ca-pub-3398911159151128\"\r\n     data-ad-slot=\"1946393371\"><\/ins>\r\n<script>\r\n     (adsbygoogle = window.adsbygoogle || []).push({});\r\n<\/script>\n<p><strong><span style=\"font-size: 14pt;\">Step 4:\u00a0<\/span> \u00a0<\/strong>Copy the public key files to their respective destination servers to update <code>authorized_keys<\/code>.\u00a0 <em>mwiapp01<\/em> server&#8217;s public key <code>mwiapp01-id_rsa.pub<\/code> would go to <em>mwiapp02<\/em> server and vice versa<\/p>\n<p><span style=\"font-size: 14pt;\"><strong>4a)<\/strong> <\/span>Copy the <code>mwiapp01<\/code> public key to <code>mwiapp02<\/code> and update authorized key using <span style=\"color: #096c87;\">ansible authorized_key module<\/span><\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"bootstrap4\" data-enlighter-linenumbers=\"false\">aksarav@middlewareinventory:~$ ansible app -m authorized_key -a \"user='weblogic' state='present' key='{{ lookup('file','buffer\/mwiapp01-id_rsa.pub')}}'\" &#8211; limit=mwiapp02 -i ansible_hosts -b &#8211; become-user=weblogic\r\n\r\nmwiapp02 | SUCCESS =&gt; {\r\n    \"changed\": true,\r\n    \"comment\": null,\r\n    \"exclusive\": false,\r\n    \"key\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDIRJwtqDW614wf9vKm51oTi3mNt4CkYXB7aLxhT1sEsZILUBYBLFqc78QB2eqelmbvgWN471CcR4XAYPxImB+ibZLhBuLqz49lPWpaVl+D55THVJFiCJ5MrXZBeSD73hRX0y1cR4kuPflaYLodz\/sNOeScufomlhs+cQzwGpShSXqNtTJMl9KqqWnczBut6mdK5X\/+ETruCTVigLrKfoAGDbpFHm2MNuVNud34HUffKcnqXz8ihbH1tmlW5jy+j6mMDsMNfIA7coP\/bKoa2vVMX1sFpAQQCPhejLV26IYM5fYABVYrzxLtaiioylRyvSWl7NFTpgua+dtkbdV7aEWr creating SSH\",\r\n    \"key_options\": null,\r\n    \"keyfile\": \"\/home\/weblogic\/.ssh\/authorized_keys\",\r\n    \"manage_dir\": true,\r\n    \"path\": null,\r\n    \"state\": \"present\",\r\n    \"unique\": false,\r\n    \"user\": \"weblogic\",\r\n    \"validate_certs\": true\r\n}<\/pre>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<p><strong><span style=\"font-size: 14pt;\">4b)\u00a0<\/span>\u00a0<\/strong>Copy the <code>mwiapp02<\/code>&#8216;s public key to <code>mwiapp01<\/code>and update authorized key using <span style=\"color: #096c87;\">ansible authorized_key module<\/span><\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"bootstrap4\" data-enlighter-linenumbers=\"false\">aksarav@middlewareinventory:~$ ansible app -m authorized_key -a \"user='weblogic' state='present' key='{{ lookup('file','buffer\/mwiapp02-id_rsa.pub')}}'\" &#8211; limit=mwiapp01 -i ansible_hosts -b &#8211; become-user=weblogic\r\n\r\nmwiapp01 | SUCCESS =&gt; {\r\n\r\n    \"changed\": true,\r\n    \"comment\": null,\r\n    \"exclusive\": false,\r\n    \"key\": \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDh50TVgulXoAEcRz0rn8SEXgVVoLpaebqk+PvhpRO27JbGC6WMlwpDNxEOdXjEn9Qlotm7zF\/JUAjXaxEiPS7P5QSQjSTRxBu6YrTEV8sPnJyiocp+ll+1U74r18R88jE03+JOdxDroKROz3qpfT\/vqzTHi6hnMdWs0n8vE09+oWPorW9lqrdWQ0C+AZShIWoSc\/9nrLVDXci4rxhbwgrzyJbPd77sbV5yDoDfFLTKf3z3NQ48Gku\/7zTdTNxrHOz8wop5Iqy7fqfH7jWAxlT0mWdJ6Ac+++ARj+x\/v59hNfwMswc3rI2fE4tPNXIKC9tcnwVG3teaV1h4XxpHyWEt creating SSH\",\r\n    \"key_options\": null,\r\n    \"keyfile\": \"\/home\/weblogic\/.ssh\/authorized_keys\",\r\n    \"manage_dir\": true,\r\n    \"path\": null,\r\n    \"state\": \"present\",\r\n    \"unique\": false,\r\n    \"user\": \"weblogic\",\r\n    \"validate_certs\": true\r\n}<\/pre>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<p><strong><span style=\"font-size: 14pt;\">Step 5:<\/span>\u00a0<\/strong>Validate the SSH Key-based authentication between each server as <code>weblogic<\/code> user ( If everything we did is correct, we should be able to execute commands over SSH from one another.<\/p>\n<p><span style=\"font-size: 14pt;\"><strong>5a)\u00a0<\/strong><\/span> Invoke SSH login from <code>mwiapp01<\/code> to <code>mwiapp02<\/code>\u00a0 and execute <span style=\"color: #096c87;\">uname -n<\/span> command<\/p>\n<pre>aksarav@middlewareinventory:~$ ansible app -m shell -a \"ssh mwiapp02 'uname -a'\" -i ansible_hosts -b &#8211; become-user=weblogic &#8211; limit=mwiapp01\r\n\r\nmwiapp01 | SUCCESS | rc=0 &gt;&gt;\r\nLinux mwiapp02 3.10.0-514.2.2.el7.x86_64 #1 SMP Wed Nov 16 13:15:13 EST 2016 x86_64 x86_64 x86_64 GNU\/Linux<\/pre>\n<p><strong><span style=\"font-size: 14pt;\">5b)<\/span>\u00a0<\/strong>Invoke SSH login from <code>mwiapp02<\/code> to <code>mwiapp01<\/code>\u00a0 and execute <span style=\"color: #096c87;\">uname -n<\/span> command<\/p>\n<pre>aksarav@middlewareinventory:~\/VirtualBox VMs\/vagrantVM$ ansible app -m shell -a \"ssh mwiapp01 'uname -a'\" -i ansible_hosts -b &#8211; become-user=weblogic &#8211; limit=mwiapp02\r\n\r\nmwiapp02 | SUCCESS | rc=0 &gt;&gt;\r\nLinux mwiapp01 3.10.0-514.2.2.el7.x86_64 #1 SMP Wed Nov 16 13:15:13 EST 2016 x86_64 x86_64 x86_64 GNU\/Linux<\/pre>\n<p>&nbsp;<\/p>\n<h2><span style=\"font-size: 18pt;\">Ansible Playbook\u00a0 to Exchange keys between hosts<\/span><\/h2>\n<h3>Type1: With Ansible <span style=\"color: #db4861;\">Shell\u00a0<\/span>module and <span style=\"color: #db4861;\">Typical Commands<\/span><\/h3>\n<p><a href=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod1.png\"><img class=\"alignright wp-image-1751 size-medium\" src=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod1-300x268.png\" alt=\" How to enable SSH Key based authentication using Ansible\" width=\"300\" height=\"268\" srcset=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod1-300x268.png 300w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod1-768x686.png 768w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod1-1024x915.png 1024w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod1.png 1581w\" sizes=\"(max-width: 300px) 100vw, 300px\" \/><\/a><\/p>\n<p>In this method, We are not going to use any ansible in-built module and every step is done manually by executing the shell command. The Playbook contains the following tasks<\/p>\n<ol>\n<li><strong>Create<\/strong> an SSH\u00a0Private and Public Key using\u00a0 <code>ssh-keygen<\/code> command<\/li>\n<li><strong>Fetch<\/strong> generated key files from remote servers [mwiapp01,mwiapp02]\u00a0 to ansible master<\/li>\n<li><strong>Copy<\/strong> the file from the master to remote destination servers<\/li>\n<li><strong>Add<\/strong> the public to the mentioned user&#8217;s <code>authorized_keys<\/code> file<\/li>\n<\/ol>\n<p>&nbsp;<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"yaml\" data-enlighter-theme=\"bootstrap4\" data-enlighter-linenumbers=\"false\">---\r\n- name: Exchange Keys between servers\r\n  become: yes\r\n  become_user: weblogic\r\n  hosts: app\r\n  tasks:\r\n    - name: SSH KeyGen command\r\n      shell: &gt; \r\n        ssh-keygen -q -b 2048 -t rsa -N \"\" -C \"creating SSH\" -f ~\/.ssh\/id_rsa\r\n        creates=\"~\/.ssh\/id_rsa\"\r\n\r\n    - name: Fetch the keyfile from one server to another\r\n      fetch: \r\n        src: \"~\/.ssh\/id_rsa.pub\"\r\n        dest: \"buffer\/{{ansible_hostname}}-id_rsa.pub\"\r\n        flat: yes\r\n\r\n    - name: Copy the file from master to the destination\r\n      copy:\r\n        src: \"buffer\/{{item.dest}}-id_rsa.pub\"\r\n        dest: \"\/tmp\/remote-id_rsa.pub\"  \r\n      when: \"{{ item.dest != ansible_hostname }}\"\r\n      with_items: \r\n        - { dest: \"{{groups['app'][1]}}\"}\r\n        - { dest: \"{{groups['app'][0]}}\"}\r\n\r\n    - name: add the public key into Authorized_keys file to enable Key Auth\r\n      shell: \"cat \/tmp\/remote-id_rsa.pub &gt;&gt; ~\/.ssh\/authorized_keys\"\r\n      register: addtoauth<\/pre>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<h3>Type2: With Ansible <span style=\"color: #db4861;\">authorized_key<\/span> module<\/h3>\n<p class=\"alignnone\"><a href=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod2.png\"><img class=\"alignleft wp-image-1752 size-medium\" src=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod2-300x268.png\" alt=\"\" width=\"300\" height=\"268\" srcset=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod2-300x268.png 300w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod2-768x685.png 768w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod2-1024x913.png 1024w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/AnsibleMethod2.png 1582w\" sizes=\"(max-width: 300px) 100vw, 300px\" \/><\/a>In this method, we are going to use the ansible built-in module named <code>\"authorized_key\"<\/code>.\u00a0 The following playbook has three steps<\/p>\n<ol>\n<li><strong>Create<\/strong> an SSH\u00a0Private and Public Key using\u00a0 <code>ssh-keygen<\/code> command<\/li>\n<li><strong>Fetch<\/strong> generated key files from remote servers [mwiapp01,mwiapp02]\u00a0 to ansible master<\/li>\n<li>Use the <strong>authorized_key<\/strong> module to <strong>copy<\/strong> the file remote machine and <strong>add<\/strong> it to the mentioned user&#8217;s <code>authorized_keys<\/code> file ( <em>If you could notice, the authorized_key module is actually performing the step3 and step4 from the manual method<\/em> )<\/li>\n<\/ol>\n<p>&nbsp;<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"yaml\" data-enlighter-theme=\"bootstrap4\" data-enlighter-linenumbers=\"false\">---\r\n- name: Exchange Keys between servers\r\n  become: yes\r\n  become_user: weblogic\r\n  hosts: app\r\n  tasks:\r\n    - name: SSH KeyGen command\r\n      tags: run\r\n      shell: &gt; \r\n        ssh-keygen -q -b 2048 -t rsa -N \"\" -C \"creating SSH\" -f ~\/.ssh\/id_rsa\r\n        creates=\"~\/.ssh\/id_rsa\"\r\n\r\n    - name: Fetch the keyfile from one server to another\r\n      tags: run\r\n      fetch: \r\n        src: \"~\/.ssh\/id_rsa.pub\"\r\n        dest: \"buffer\/{{ansible_hostname}}-id_rsa.pub\"\r\n        flat: yes\r\n\r\n    - name: Copy the key add to authorized_keys using Ansible module\r\n      tags: run\r\n      authorized_key:\r\n        user: weblogic\r\n        state: present\r\n        key: \"{{ lookup('file','buffer\/{{item.dest}}-id_rsa.pub')}}\"\r\n      when: \"{{ item.dest != ansible_hostname }}\"\r\n      with_items: \r\n        - { dest: \"{{groups['app'][1]}}\"}\r\n        - { dest: \"{{groups['app'][0]}}\"}<\/pre>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n<h2>Ansible SSH Key Exchange between multiple hosts<\/h2>\n<p>Though the previously given examples have talked about Creating and Exchanging the Keys between only two servers. With a Simple modification in the same playbook. you would be able to achieve Exchanging the SSH Keys across multiple servers (or) all the servers in the host group.<\/p>\n<p>Here is the Playbook to exchange SSH key between multiple hosts.<\/p>\n<pre class=\"hljs\" style=\"display: block; overflow-x: auto; padding: 0.5em; background: #232323; color: #e6e1dc;\"><span class=\"hljs-meta\" style=\"color: #9b859d;\">---<\/span>\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">- name:<\/span> Exchange Keys between servers\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">  hosts:<\/span> multi\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">  tasks:<\/span>\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">    - name:<\/span> SSH KeyGen command\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">      tags:<\/span> run\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">      shell:<\/span> <span class=\"hljs-string\" style=\"color: #a5c261;\">&gt; \r\n        ssh-keygen -q -b 2048 -t rsa -N \"\" -C \"creating SSH\" -f ~\/.ssh\/id_rsa\r\n        creates=\"~\/.ssh\/id_rsa\"\r\n\r\n<\/span><span class=\"hljs-attr\" style=\"color: #6d9cbe;\">    - name:<\/span> Fetch the keyfile from the node to master\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">      tags:<\/span> run\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">      fetch:<\/span> \r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">        src:<\/span> <span class=\"hljs-string\" style=\"color: #a5c261;\">\"~\/.ssh\/id_rsa.pub\"<\/span>\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">        dest:<\/span> <span class=\"hljs-string\" style=\"color: #a5c261;\">\"buffer\/<span class=\"hljs-template-variable\" style=\"color: #a5c261;\">{{ansible_hostname}}<\/span>-id_rsa.pub\"<\/span>\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">        flat:<\/span> <span class=\"hljs-literal\">yes<\/span>\r\n\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">    - name:<\/span> Copy the key add to authorized_keys using Ansible module\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">      tags:<\/span> runcd\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">      authorized_key:<\/span>\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">        user:<\/span> vagrant\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">        state:<\/span> present\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">        key:<\/span> <span class=\"hljs-string\" style=\"color: #a5c261;\">\"<span class=\"hljs-template-variable\" style=\"color: #a5c261;\">{{ lookup('file','buffer\/{{item}}<\/span>-id_rsa.pub')}}\"<\/span>\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">      when:<\/span> <span class=\"hljs-string\" style=\"color: #a5c261;\">\"<span class=\"hljs-template-variable\" style=\"color: #a5c261;\">{{ item != ansible_hostname }}<\/span>\"<\/span>\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\">      with_items:<\/span> \r\n<span class=\"hljs-bullet\" style=\"color: #6d9cbe;\">        -<\/span> <span class=\"hljs-string\" style=\"color: #a5c261;\">\"<span class=\"hljs-template-variable\" style=\"color: #a5c261;\">{{ groups['multi'] }}<\/span>\"<\/span>       \r\n\r\n<\/pre>\n<p><strong>What is the difference<\/strong><\/p>\n<p>we have changed the loop with_items to parse all the servers in the host group instead of two specific servers. These are the two modified lines from the previous example.<\/p>\n<pre class=\"hljs\" style=\"display: block; overflow-x: auto; padding: 0.5em; background: #232323; color: #e6e1dc;\"><span class=\"hljs-attr\" style=\"color: #6d9cbe;\"> when:<\/span> <span class=\"hljs-string\" style=\"color: #a5c261;\">\"<span class=\"hljs-template-variable\" style=\"color: #a5c261;\">{{ item != ansible_hostname }}<\/span>\"<\/span>\r\n<span class=\"hljs-attr\" style=\"color: #6d9cbe;\"> with_items:<\/span> \r\n<span class=\"hljs-bullet\" style=\"color: #6d9cbe;\">        -<\/span> <span class=\"hljs-string\" style=\"color: #a5c261;\">\"<span class=\"hljs-template-variable\" style=\"color: #a5c261;\">{{ groups['multi'] }}<\/span>\"<\/span><\/pre>\n<h3><script async src=\"https:\/\/pagead2.googlesyndication.com\/pagead\/js\/adsbygoogle.js\"><\/script>\r\n<ins class=\"adsbygoogle\"\r\n     style=\"display:block; text-align:center;\"\r\n     data-ad-layout=\"in-article\"\r\n     data-ad-format=\"fluid\"\r\n     data-ad-client=\"ca-pub-3398911159151128\"\r\n     data-ad-slot=\"1946393371\"><\/ins>\r\n<script>\r\n     (adsbygoogle = window.adsbygoogle || []).push({});\r\n<\/script><\/h3>\n<h3>Playbook execution Output<\/h3>\n<p>We have saved the Type1 playbook in the name <code>sshkey-exchange-t1.yaml<\/code>\u00a0and executed it. and here is the output.<\/p>\n<p>In the last task. you could see that we successfully initiated an SSH connection\u00a0 from one another and ran the <code>uname -a<\/code> command<\/p>\n<p><a href=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2018-09-13-at-3.57.14-AM.png\"><img class=\"post-img alignnone wp-image-1762 size-full\" src=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2018-09-13-at-3.57.14-AM.png\" alt=\" Enable SSH Key based authentication using Ansible\" width=\"1165\" height=\"835\" srcset=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2018-09-13-at-3.57.14-AM.png 1165w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2018-09-13-at-3.57.14-AM-300x215.png 300w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2018-09-13-at-3.57.14-AM-768x550.png 768w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2018-09-13-at-3.57.14-AM-1024x734.png 1024w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/Screen-Shot-2018-09-13-at-3.57.14-AM-90x65.png 90w\" sizes=\"(max-width: 1165px) 100vw, 1165px\" \/><\/a><\/p>\n<p>Hope it helps.<\/p>\n<p>We recommend the following article in case if you are looking to exchange IP between multiple hosts in Ansible. adding an IP in \/etc\/hosts file of multiple hosts in Ansible.<\/p>\n<blockquote class=\"wp-embedded-content\" data-secret=\"Xz7hIxGOpP\"><p><a href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-update-etc-hosts-file-across-all-hosts\/\">ansible update \/etc\/hosts file with IP of all hosts across all hosts<\/a><\/p><\/blockquote>\n<p><iframe class=\"wp-embedded-content\" sandbox=\"allow-scripts\" security=\"restricted\" style=\"position: absolute; clip: rect(1px, 1px, 1px, 1px);\" title=\"&#8220;ansible update \/etc\/hosts file with IP of all hosts across all hosts&#8221; &#8212; Middleware Inventory\" src=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-update-etc-hosts-file-across-all-hosts\/embed\/#?secret=Xz7hIxGOpP\" data-secret=\"Xz7hIxGOpP\" width=\"600\" height=\"338\" frameborder=\"0\" marginwidth=\"0\" marginheight=\"0\" scrolling=\"no\"><\/iframe><\/p>\n<p>For any questions (or) support. Please feel free to comment<\/p>\n<p>Rate this article [ratings]<\/p>\n<p>Cheers,<\/p>\n<p>Rumen Lishkov<\/p>\n<div id=\"postfollow\">\r\n<a href='https:\/\/ko-fi.com\/O4O51FG7C' target='_blank'><img height='46' style='border:0px;height:46px;width: 186px' src='https:\/\/az743702.vo.msecnd.net\/cdn\/kofi3.png?v=2' border='0' alt='Buy Me a Coffee at ko-fi.com' \/><\/a>\r\n<p>Follow us on<a href=\"http:\/\/www.facebook.com\/middlewareinventory\">Facebook<\/a> or<a href=\"http:\/\/www.twitter.com\/mwinventory\">Twitter<\/a>\r\n<\/br>\r\nFor more practical videos and tutorials. <a href=\"https:\/\/www.youtube.com\/channel\/UCRuqBFM6ioWwviNJkgOjeWw?sub_confirmation=1\">Subscribe to our channel<\/a>\r\n<\/br>\r\nFollow me on Linkedin <a href=\"https:\/\/www.linkedin.com\/comm\/mynetwork\/discovery-see-all?usecase=PEOPLE_FOLLOWS&followMember=saravakmwinventory\">My Profile<\/a>\r\n<\/br>\r\n<\/i>For any Consultation or to hire us <a href=\"mailto:rumenlishkoff@gmail.com\"> rumenlishkoff@gmail.com<\/a>\r\n<\/br>\r\nIf you like this article. Show your Support! <a href=\"https:\/\/ko-fi.com\/middlewareinventory\">Buy me a Coffee.<\/a>\r\n<\/br>\r\n<\/p>\r\n<p style=\"color: palevioletred !important;\">Signup for Exclusive \"Subscriber-only\" Content<\/p>\r\n\n\t\t<div class=\"emaillist\">\n\t\t\t<form action=\"#\" method=\"post\" class=\"es_subscription_form es_shortcode_form\" id=\"es_subscription_form_1670576950\" data-source=\"ig-es\">\n\t\t\t\t\t\t\t\t<div class=\"es-field-wrap\"><label>Name*<br \/><input type=\"text\" name=\"name\" class=\"ig_es_form_field_name\" placeholder=\"\" value=\"\" required=\"required\" \/><\/label><\/div><div class=\"es-field-wrap\"><label>Email*<br \/><input class=\"es_required_field es_txt_email ig_es_form_field_email\" type=\"email\" name=\"email\" value=\"\" placeholder=\"\" required=\"required\" \/><\/label><\/div><input type=\"hidden\" name=\"lists[]\" value=\"1\" \/><input type=\"hidden\" name=\"form_id\" value=\"3\" \/>\n\t\t\t\t<input type=\"hidden\" name=\"es_email_page\" value=\"1735\"\/>\n\t\t\t\t<input type=\"hidden\" name=\"es_email_page_url\" value=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/\"\/>\n\t\t\t\t<input type=\"hidden\" name=\"status\" value=\"Unconfirmed\"\/>\n\t\t\t\t<input type=\"hidden\" name=\"es-subscribe\" id=\"es-subscribe\" value=\"7aebfb1a9b\"\/>\n\t\t\t\t<label style=\"position:absolute;top:-99999px;left:-99999px;z-index:-99;\"><input type=\"email\" name=\"es_hp_email\" class=\"es_required_field\" tabindex=\"-1\" autocomplete=\"-1\" value=\"\"\/><\/label>\n\t\t\t\t\t\t\t\t<input type=\"submit\" name=\"submit\" class=\"es_subscription_form_submit es_submit_button es_textbox_button\" id=\"es_subscription_form_submit_1670576950\" value=\"Subscribe\"\/>\n\n\t\t\t\t\n\t\t\t\t<span class=\"es_spinner_image\" id=\"spinner-image\"><img src=\"https:\/\/www.middlewareinventory.com\/wp-content\/plugins\/email-subscribers\/lite\/public\/images\/spinner.gif\" alt=\"Loading\"\/><\/span>\n\n\t\t\t<\/form>\n\n\t\t\t<span class=\"es_subscription_message\" id=\"es_subscription_message_1670576950\"><\/span>\n\t\t<\/div>\n\n\t\t\r\n<\/div>\r\n<hr>\n","protected":false},"excerpt":{"rendered":"<p>SSH Key-based authentication setup in LINUX (or) UNIX based OS is one of the major platform\u00a0services related task and most frequently executed task by Unix admins. Ansible, An IT Automation tool could automate this tedious task as well. SSH Key based authentication is indispensable when it comes to automation. Even[&#8230;]<\/p>\n","protected":false},"author":1,"featured_media":1756,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"_et_pb_use_builder":"","_et_pb_old_content":"","_et_gb_content_width":""},"categories":[98],"tags":[142,144,143,145],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v14.9 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>Ansible SSH Key transfer from one host to another - local and remote<\/title>\n<meta name=\"description\" content=\"SSH Key based authentication setup using ansible. In this post, we are going to see how to enable the SSH key-based authentication between two remote servers using ansible by creating and exchanging the keys. We are going to use ansible built-in modules like Shell and Copy and Fetch and most importantly authorized_key\" \/>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"Ansible SSH Key transfer from one host to another - local and remote\" \/>\n<meta property=\"og:description\" content=\"SSH Key based authentication setup using ansible. In this post, we are going to see how to enable the SSH key-based authentication between two remote servers using ansible by creating and exchanging the keys. We are going to use ansible built-in modules like Shell and Copy and Fetch and most importantly authorized_key\" \/>\n<meta property=\"og:url\" content=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/\" \/>\n<meta property=\"og:site_name\" content=\"Middleware Inventory\" \/>\n<meta property=\"article:publisher\" content=\"http:\/\/www.facebook.com\/devopsjunc\" \/>\n<meta property=\"article:published_time\" content=\"2018-09-12T22:56:35+00:00\" \/>\n<meta property=\"article:modified_time\" content=\"2022-02-04T05:19:28+00:00\" \/>\n<meta property=\"og:image\" content=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/TheObjective.png\" \/>\n\t<meta property=\"og:image:width\" content=\"741\" \/>\n\t<meta property=\"og:image:height\" content=\"404\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<meta name=\"twitter:creator\" content=\"@mwinventory\" \/>\n<meta name=\"twitter:site\" content=\"@mwinventory\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"Organization\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#organization\",\"name\":\"Middleware Inventory\",\"url\":\"https:\/\/www.middlewareinventory.com\/\",\"sameAs\":[\"http:\/\/www.facebook.com\/devopsjunc\",\"https:\/\/www.youtube.com\/channel\/UCRuqBFM6ioWwviNJkgOjeWw\",\"https:\/\/twitter.com\/mwinventory\"],\"logo\":{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#logo\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2020\/09\/Screenshot-2020-09-18-at-3.49.40-AM.jpg\",\"width\":300,\"height\":107,\"caption\":\"Middleware Inventory\"},\"image\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#logo\"}},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#website\",\"url\":\"https:\/\/www.middlewareinventory.com\/\",\"name\":\"Devops Junction\",\"description\":\"An inventory of [i]nformation, Middleware and much more.\",\"publisher\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#organization\"},\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":\"https:\/\/www.middlewareinventory.com\/?s={search_term_string}\",\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/#primaryimage\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2018\/09\/TheObjective.png\",\"width\":741,\"height\":404},{\"@type\":\"WebPage\",\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/#webpage\",\"url\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/\",\"name\":\"Ansible SSH Key transfer from one host to another - local and remote\",\"isPartOf\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#website\"},\"primaryImageOfPage\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/#primaryimage\"},\"datePublished\":\"2018-09-12T22:56:35+00:00\",\"dateModified\":\"2022-02-04T05:19:28+00:00\",\"description\":\"SSH Key based authentication setup using ansible. In this post, we are going to see how to enable the SSH key-based authentication between two remote servers using ansible by creating and exchanging the keys. We are going to use ansible built-in modules like Shell and Copy and Fetch and most importantly authorized_key\",\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/\"]}]},{\"@type\":\"Article\",\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/#article\",\"isPartOf\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/#webpage\"},\"author\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#\/schema\/person\/050bf13e27b309d29d1bda45c4eb3147\"},\"headline\":\"Ansible SSH Key transfer from one host to another &#8211; local and remote\",\"datePublished\":\"2018-09-12T22:56:35+00:00\",\"dateModified\":\"2022-02-04T05:19:28+00:00\",\"mainEntityOfPage\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/#webpage\"},\"commentCount\":0,\"publisher\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#organization\"},\"image\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/#primaryimage\"},\"keywords\":\"Ansible authorized_key module example,ansible examples,ansible SSH key based authentication between servers,SSH Key based authentication\",\"articleSection\":\"Ansible\",\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"CommentAction\",\"name\":\"Comment\",\"target\":[\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ssh-key-exchange\/#respond\"]}]},{\"@type\":\"Person\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#\/schema\/person\/050bf13e27b309d29d1bda45c4eb3147\",\"name\":\"Rumen Lishkov\",\"image\":{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#personlogo\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/secure.gravatar.com\/avatar\/c22e4a54d67750291a9892531f94ffb3?s=96&d=mm&r=g\",\"caption\":\"Rumen Lishkov\"}}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","_links":{"self":[{"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/posts\/1735"}],"collection":[{"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/comments?post=1735"}],"version-history":[{"count":5,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/posts\/1735\/revisions"}],"predecessor-version":[{"id":8089,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/posts\/1735\/revisions\/8089"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/media\/1756"}],"wp:attachment":[{"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/media?parent=1735"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/categories?post=1735"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/tags?post=1735"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}