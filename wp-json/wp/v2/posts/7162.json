{"id":7162,"date":"2021-08-22T21:12:59","date_gmt":"2021-08-22T15:42:59","guid":{"rendered":"https:\/\/www.middlewareinventory.com\/?p=7162"},"modified":"2022-01-12T01:52:27","modified_gmt":"2022-01-11T20:22:27","slug":"ansible-find-multiple-files-with-pattern-replace","status":"publish","type":"post","link":"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/","title":{"rendered":"Ansible Find multiple files with pattern and replace"},"content":{"rendered":"<p>In this post we are going we are going to see how to find a list of\u00a0 files containing a text or a pattern and replace them at once.<\/p>\n<p>As you know I have written a dedicated and brief articles on both Ansible find and replace modules with many examples.<\/p>\n<ul>\n<li><a href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-examples\/\">Ansible Find Introduction and\u00a0 examples<\/a><\/li>\n<li><a href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-replace-line-in-file-ansible-replace-examples\">Ansible Replace Introduction and examples<\/a><\/li>\n<\/ul>\n<p>But this article is going to be quick one unlike those brief ones with narrow focus.<\/p>\n<p>As mentioned on the first line we are going to find the list of files in a directory and sub directories and look for a pattern in all of them<\/p>\n<p>If the file contains the specific pattern we are looking for, we are going to replace them after taking a backup of that file.<\/p>\n<p>To keep this article short and precise am not explaining the basics of find and replace modules and going straight to our objective.<\/p>\n<p>If you are completely new to Ansible. Please refer to our<a href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-playbook-example\/\"> Introduction to Ansible Playbook<\/a> and <a href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-ad-hoc-commands\/\">Ad Hoc commands<\/a> article<\/p>\n<p>&nbsp;<\/p>\n<h2>What we are going to do<\/h2>\n<p>To make this playbook relevent, am taking up some real time requirement.<\/p>\n<p>Our requirement is to find the jobs which are using the outdated\u00a0 <code>https:\/\/github.com\/org\/repo<\/code> based urls and replacing them with SSH based URLs <code>git@github.com:org\/repo.git<\/code><\/p>\n<p>If you are not aware, Jenkins creates a configuration file for each job we are creating on the UI and they would be present on the Jenkins Server under the <code>JENKINS_HOME\/jobs\/&lt;job name&gt;\/config.xml<\/code> location<\/p>\n<p>So we are going find these config.xml files and try to pattern match to find if the job is using the <code>https<\/code> based GIT urls and replace them to SSH url.<\/p>\n<p>Let&#8217;s go<\/p>\n<script async src=\"https:\/\/pagead2.googlesyndication.com\/pagead\/js\/adsbygoogle.js\"><\/script>\r\n<ins class=\"adsbygoogle\"\r\n     style=\"display:block; text-align:center;\"\r\n     data-ad-layout=\"in-article\"\r\n     data-ad-format=\"fluid\"\r\n     data-ad-client=\"ca-pub-3398911159151128\"\r\n     data-ad-slot=\"1946393371\"><\/ins>\r\n<script>\r\n     (adsbygoogle = window.adsbygoogle || []).push({});\r\n<\/script>\n<p>&nbsp;<\/p>\n<h2>The Ansible Playbook that find the files and replace a pattern<\/h2>\n<p>So we are clear on the requirement I believe which has two sub tasks<\/p>\n<ul>\n<li>Find the files using Ansible find module<\/li>\n<li>Look for a pattern and replace using Ansible replace module.<\/li>\n<\/ul>\n<p>both these sub tasks would be represented as a <code>task<\/code> in ansible playbook.<\/p>\n<p>Here is the playbook<\/p>\n<pre class=\"EnlighterJSRAW\" data-enlighter-language=\"yaml\" data-enlighter-theme=\"bootstrap4\" data-enlighter-linenumbers=\"false\">---\r\n  - name: Replace line in file examples\r\n    hosts: jenkinsserver\r\n    tasks:\r\n\r\n      - name: Find the files\r\n        become: true\r\n        become_user: jenkins\r\n        find:\r\n          paths: \/var\/lib\/jenkins\/jobs\/\r\n          file_type: file\r\n          recurse: yes\r\n          patterns: \r\n           - config.xml\r\n          use_regex: true\r\n        register: configfiles\r\n      \r\n      - debug: \r\n          msg: \"{{configfiles.files | map(attribute='path')| list }}\"\r\n\r\n      - name: \"Changing jenkins Git URL\"\r\n        become: true\r\n        become_user: jenkins\r\n        replace: \r\n          path: \"{{item.path}}\"\r\n          regexp: '(&lt;url&gt;)(https:\\\/\\\/)(github\\.com)(\\\/)(gritfy)(\\\/\\w+)(|\\\/)(&lt;\\\/url)'\r\n          replace: '\\1git@\\3:\\5\\6.git\\8'\r\n          after: '\\&lt;hudson.plugins.git.UserRemoteConfig\\&gt;'\r\n          before: '\\&lt;\\\/hudson.plugins.git.UserRemoteConfig\\&gt;'\r\n          backup: yes\r\n        with_items:\r\n          - \"{{configfiles.files}}\"\r\n<\/pre>\n<p>&nbsp;<\/p>\n<p><strong>The First task<\/strong> is to find the files on the path <code>\/var\/lib\/jenkins\/jobs<\/code> folder using Ansible find module.<\/p>\n<p>we are using the file name as the <code>patterns<\/code> to find<\/p>\n<p>The resulting file names would be saved into a register variable named <code>configfiles<\/code><\/p>\n<p><strong>The Second task <\/strong>is just a debug print statement and displaying only the file names from the variable we have created on the first task.<\/p>\n<p>We are using <code>Map<\/code> filter with <code>attribute<\/code> selection to do the same.<\/p>\n<p><strong>The Third Task<\/strong>\u00a0 performs the actual find and replace with in the file. It look the pattern that we have defined on the <code>regexp<\/code><\/p>\n<pre> regexp: '(&lt;url&gt;)(https:\\\/\\\/)(github\\.com)(\\\/)(gritfy)(\\\/\\w+)(|\\\/)(&lt;\\\/url)'<\/pre>\n<p>The regular expression pattern we have given here find various parts of the github URL and group them.<\/p>\n<p>These group would be back referred based on their position.<\/p>\n<script async src=\"https:\/\/pagead2.googlesyndication.com\/pagead\/js\/adsbygoogle.js\"><\/script>\r\n<ins class=\"adsbygoogle\"\r\n     style=\"display:block; text-align:center;\"\r\n     data-ad-layout=\"in-article\"\r\n     data-ad-format=\"fluid\"\r\n     data-ad-client=\"ca-pub-3398911159151128\"\r\n     data-ad-slot=\"1946393371\"><\/ins>\r\n<script>\r\n     (adsbygoogle = window.adsbygoogle || []).push({});\r\n<\/script>\n<p>For example :<\/p>\n<p><code>\\1<\/code> represents the <code>&lt;url&gt;<\/code><\/p>\n<p><code>\\2<\/code> represents the <code>https:\/\/github.com<\/code><\/p>\n<p>The following screen shot can explain the groups better<\/p>\n<p><a href=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-8.46.55-PM-scaled.jpg\"><img class=\"alignnone size-full wp-image-7165\" src=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-8.46.55-PM-scaled.jpg\" alt=\"Ansible Find files and Replace\" width=\"2560\" height=\"1090\" srcset=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-8.46.55-PM-scaled.jpg 2560w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-8.46.55-PM-300x128.jpg 300w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-8.46.55-PM-1024x436.jpg 1024w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-8.46.55-PM-768x327.jpg 768w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-8.46.55-PM-1536x654.jpg 1536w, https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-8.46.55-PM-2048x872.jpg 2048w\" sizes=\"(max-width: 2560px) 100vw, 2560px\" \/><\/a><\/p>\n<p>You can see we have used these group names on the replace pattern.<\/p>\n<pre>replace: '\\1git@\\3:\\5\\6.git\\8'<\/pre>\n<p>we are also using the <code>before<\/code> and <code>after<\/code> options of replace module which helps us to find the right pattern at right place.<\/p>\n<p>This is briefly covered on the <a href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-replace-line-in-file-ansible-replace-examples\">Ansible Replace introduction and examples<\/a> article<\/p>\n<p>&nbsp;<\/p>\n<p>Cheers<br \/>\nRumen Lishkov<\/p>\n<p>&nbsp;<\/p>\n<p>&nbsp;<\/p>\n","protected":false},"excerpt":{"rendered":"<p>In this post we are going we are going to see how to find a list of\u00a0 files containing a text or a pattern and replace them at once. As you know I have written a dedicated and brief articles on both Ansible find and replace modules with many examples.[&#8230;]<\/p>\n","protected":false},"author":1,"featured_media":7167,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"_et_pb_use_builder":"","_et_pb_old_content":"","_et_gb_content_width":""},"categories":[98],"tags":[],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v14.9 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>Ansible Find multiple files with pattern and replace | Devops Junction<\/title>\n<meta name=\"description\" content=\"Ansible Find a pattern on multiple files and replace them using Ansible Find and Replace modules. Replace a pattern within multiple files using Ansible. Ansible Find multiple files with pattern.\" \/>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"Ansible Find multiple files with pattern and replace | Devops Junction\" \/>\n<meta property=\"og:description\" content=\"Ansible Find a pattern on multiple files and replace them using Ansible Find and Replace modules. Replace a pattern within multiple files using Ansible. Ansible Find multiple files with pattern.\" \/>\n<meta property=\"og:url\" content=\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/\" \/>\n<meta property=\"og:site_name\" content=\"Middleware Inventory\" \/>\n<meta property=\"article:publisher\" content=\"http:\/\/www.facebook.com\/devopsjunc\" \/>\n<meta property=\"article:published_time\" content=\"2021-08-22T15:42:59+00:00\" \/>\n<meta property=\"article:modified_time\" content=\"2022-01-11T20:22:27+00:00\" \/>\n<meta property=\"og:image\" content=\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-9.11.58-PM.png\" \/>\n\t<meta property=\"og:image:width\" content=\"2398\" \/>\n\t<meta property=\"og:image:height\" content=\"1740\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<meta name=\"twitter:creator\" content=\"@mwinventory\" \/>\n<meta name=\"twitter:site\" content=\"@mwinventory\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"Organization\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#organization\",\"name\":\"Middleware Inventory\",\"url\":\"https:\/\/www.middlewareinventory.com\/\",\"sameAs\":[\"http:\/\/www.facebook.com\/devopsjunc\",\"https:\/\/www.youtube.com\/channel\/UCRuqBFM6ioWwviNJkgOjeWw\",\"https:\/\/twitter.com\/mwinventory\"],\"logo\":{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#logo\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2020\/09\/Screenshot-2020-09-18-at-3.49.40-AM.jpg\",\"width\":300,\"height\":107,\"caption\":\"Middleware Inventory\"},\"image\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#logo\"}},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#website\",\"url\":\"https:\/\/www.middlewareinventory.com\/\",\"name\":\"Devops Junction\",\"description\":\"An inventory of [i]nformation, Middleware and much more.\",\"publisher\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#organization\"},\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":\"https:\/\/www.middlewareinventory.com\/?s={search_term_string}\",\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/#primaryimage\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/www.middlewareinventory.com\/wp-content\/uploads\/2021\/08\/Screenshot-2021-08-22-at-9.11.58-PM.png\",\"width\":2398,\"height\":1740,\"caption\":\"Ansible Find Multiple Files and Replace\"},{\"@type\":\"WebPage\",\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/#webpage\",\"url\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/\",\"name\":\"Ansible Find multiple files with pattern and replace | Devops Junction\",\"isPartOf\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#website\"},\"primaryImageOfPage\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/#primaryimage\"},\"datePublished\":\"2021-08-22T15:42:59+00:00\",\"dateModified\":\"2022-01-11T20:22:27+00:00\",\"description\":\"Ansible Find a pattern on multiple files and replace them using Ansible Find and Replace modules. Replace a pattern within multiple files using Ansible. Ansible Find multiple files with pattern.\",\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/\"]}]},{\"@type\":\"Article\",\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/#article\",\"isPartOf\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/#webpage\"},\"author\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#\/schema\/person\/050bf13e27b309d29d1bda45c4eb3147\"},\"headline\":\"Ansible Find multiple files with pattern and replace\",\"datePublished\":\"2021-08-22T15:42:59+00:00\",\"dateModified\":\"2022-01-11T20:22:27+00:00\",\"mainEntityOfPage\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/#webpage\"},\"commentCount\":0,\"publisher\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/#organization\"},\"image\":{\"@id\":\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/#primaryimage\"},\"articleSection\":\"Ansible\",\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"CommentAction\",\"name\":\"Comment\",\"target\":[\"https:\/\/www.middlewareinventory.com\/blog\/ansible-find-multiple-files-with-pattern-replace\/#respond\"]}]},{\"@type\":\"Person\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#\/schema\/person\/050bf13e27b309d29d1bda45c4eb3147\",\"name\":\"Rumen Lishkov\",\"image\":{\"@type\":\"ImageObject\",\"@id\":\"https:\/\/www.middlewareinventory.com\/#personlogo\",\"inLanguage\":\"en-US\",\"url\":\"https:\/\/secure.gravatar.com\/avatar\/c22e4a54d67750291a9892531f94ffb3?s=96&d=mm&r=g\",\"caption\":\"Rumen Lishkov\"}}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","_links":{"self":[{"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/posts\/7162"}],"collection":[{"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/comments?post=7162"}],"version-history":[{"count":4,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/posts\/7162\/revisions"}],"predecessor-version":[{"id":7174,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/posts\/7162\/revisions\/7174"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/media\/7167"}],"wp:attachment":[{"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/media?parent=7162"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/categories?post=7162"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/www.middlewareinventory.com\/wp-json\/wp\/v2\/tags?post=7162"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}